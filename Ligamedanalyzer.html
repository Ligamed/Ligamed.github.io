<!DOCTYPE HTML>
<html>
<head>
	<title>LIGAMED ANALYZER</title>
  <link href="https://fonts.googleapis.com/css?family=Comfortaa" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/97/three.min.js"></script>

  <style>
  body,h1,p {margin: 16;background: #ffffff;color: black;font-family: 'Comfortaa', cursive;}
  h1 {font-size: 20px;}
  #bigButton {
    background-color: green; border: none; color: black; padding: 1px; text-align: center;
    text-decoration: none; font-size: 8px; margin: 4px 10px; height: 16px; width: 16px;
    border-radius: 50%; outline:none; font-family: 'Open Sans', sans-serif;
  }
  table, th, td {border: 1px solid black; border-collapse: collapse;}
  th, td {padding: 2px;}
  .runbutton {
  	background-color: #4CAF50;
  	border: none;
 	color: white;
  	padding: 0px 0px;
  	text-align: center;
  	font-size: 0px;
  	cursor: pointer;
	}
  </style>
</head>
<body>
<p><button onclick="runData()" class="runbutton"> <img src="Ligamed_logo.jpg" width="600"> </button></p>
<h1 id="line1" style = "display:none">LIGAMED ANALRAPIST</h1>
<h4 id="line2" style = "display:none">THE WORLD'S FIRST ANKLE ANALYST-THERAPIST</h4>
<br>
<p><button onclick="loadLocalData()" type="button">Click to Load</button></p>
<p><button onclick="stuffEverythingHere()" type="button">Click Run</button></p>
<p><button onclick="dataClear()" type="button">Click to clear</button></p>
<div id="result"></div>
<br>
<p>All left training, averaged left training, all right training, averaged right training, all data with mag. of acc.</p>	
<div id="trainedleftdegrees"></div>
<div id="trainedaverageleftdegrees"></div>
<div id="trainedrightdegrees"></div>
<div id="trainedaveragerightdegrees"></div>
<div id="AkshaysVariable"></div>
<p>Result</p>
<td><button onclick="saveTextAsFile()">Save Data to File</button></td>
   <br>
   <br>
   <tr>
        <td>Select a File to Load:</td>
        <td><input type="file" id="fileToLoad"></td>
        <td><button onclick="loadFileAsText()">Load Selected File</button><td>
    </tr>
    <p id="temparray"></p>

</body>
<script type="text/javascript">



function loadLocalData(){
fullArray = JSON.parse(localStorage.getItem("ligamedData") || "[]");
document.getElementById("result").innerHTML = fullArray;
}

//function that runs like... everything
function stuffEverythingHere() { 
  // Loads data
  document.getElementById("result").innerHTML = fullArray;
  //set up training datasets
  

  var angleMovedLeft =[];
  var angleMovedRight = [];
  //sets training data to its own arrays
  for (var i = 0; i <= fullArray.length-1; i++) {
  	if (fullArray[i][0] == "breakleft") {
  		var trainLeftArray = [];
  		var j=1;
  		while(j==1){
  			i=1+i;
  			if (fullArray[i][0] == "resumeleft") {j=0;}
  			else{
  			trainLeftArray.push(fullArray[i]);}
  		}
  		angleMovedLeft.push(angleIntegrate(trainLeftArray));
  	}
   	if (fullArray[i][0] == "breakright") {
  		var trainRightArray = [];
  		var j=1;
  		while(j==1){
  			i=1+i;
  			if (fullArray[i][0] == "resumeright") {j=0;}
  			else{
  			trainRightArray.push(fullArray[i]);}
  		}
  		angleMovedRight.push(angleIntegrate(trainRightArray));

  	
  	} 	
  }
	for (var i = 0; i <= fullArray.length-1; i++) {
		fullArray[i][7] = (accMagnitude(fullArray[i][2],fullArray[i][3],fullArray[i][4]));	

	}
	var averagedLeft = angleAverage(angleMovedLeft);
	var averagedRight = angleAverage(angleMovedRight);
	fullArray = checkAngle(fullArray);
  document.getElementById("trainedleftdegrees").innerHTML = angleMovedLeft;
  document.getElementById("trainedaverageleftdegrees").innerHTML = averagedLeft;
  document.getElementById("trainedrightdegrees").innerHTML = angleMovedRight;
  document.getElementById("trainedaveragerightdegrees").innerHTML = averagedRight;
  document.getElementById("AkshaysVariable").innerHTML = fullArray;


}

function dataClear() {
localStorage.clear()
document.getElementById("result").innerHTML = "";
}


//computation functions below

function angleIntegrate(inputArray){
	var anglexSum = 0;
	var angleySum = 0;
	var anglezSum = 0;
	var timeStart = inputArray[0][0];
	var timeEnd = inputArray[inputArray.length-1][0]
	for (var i = 1; i <= inputArray.length - 1; i++) {
		anglexSum = (inputArray[i][4])*(inputArray[i][0]-inputArray[i-1][0])  + anglexSum;
		angleySum = (inputArray[i][5])*(inputArray[i][0]-inputArray[i-1][0])  + angleySum;
		anglezSum = (inputArray[i][6])*(inputArray[i][0]-inputArray[i-1][0])  + anglezSum;
	}
	var anglex = anglexSum/1000;
;	var angley = angleySum/1000;
	var anglez = anglezSum/1000;
	anglex = anglex.toFixed(2);
	angley = angley.toFixed(2);
	anglez = anglez.toFixed(2);

	return [anglex,angley,anglez]
}

function angleAverage(inputArray){
	var x = 0;
	var y = 0;
	var z = 0;
	for (var i = 0; i <= inputArray.length - 1; i++) {
		x = x + Number(inputArray[i][0]);
		y = y + Number(inputArray[i][1]);
		z = z + Number(inputArray[i][2]);
	}
	x = x / inputArray.length;
	y = y / inputArray.length;
	z = z / inputArray.length;
	x = x.toFixed(2);
	y = y.toFixed(2);
	z = z.toFixed(2);
	return [x,y,z];
}


//Akshay is helping
function accMagnitude(x,y,z){
	var m = 0;
	x = Math.pow(x,2);
	y = Math.pow(y,2);
	z = Math.pow(z,2);
	m = Math.sqrt((x+y+z));
	return m;

}

function checkAngle(inputArray){
	for (var i = 100; i <= inputArray.length - 1; i++) {
		var j = i;
		var x = 0;
		var y = 0;
		var z = 0;
		
		while (inputArray[i][0] - inputArray[j][0] <= 1000){
			x = x + inputArray[j][4]*(inputArray[j][0]-inputArray[j-1][0])/1000;
			y = y + inputArray[j][5]*(inputArray[j][0]-inputArray[j-1][0])/1000;
			z = z + inputArray[j][6]*(inputArray[j][0]-inputArray[j-1][0])/1000;
			j = j - 1;
		}
		x = x.toFixed(2);
		y = y.toFixed(2);
		z = z.toFixed(2);
		inputArray[i][8] = x;
		inputArray[i][9] = y;
		inputArray[i][10] = z;
	}
	return inputArray

}






















//Utility functions below

function saveTextAsFile(){
	var headingsArray = fullArray;
	headingsArray.reverse();
	headingsArray.push(["TimeStamp","x","y","z","RollVel","PitchVel","YawVel","Acc Mag","Roll","Pitch","Yaw"]);
	headingsArray.reverse();


	let csvContent = "data:text/csv;charset=utf-8," 
   		 + headingsArray.map(e => e.join(",")).join("\n");
	var encodedUri = encodeURI(csvContent);
	window.open(encodedUri);
	var encodedUri = encodeURI(csvContent);
	var link = document.createElement("a");
	link.setAttribute("href", encodedUri);
	link.setAttribute("download", "ligamed_Data.csv");
	document.body.appendChild(link); // Required for FF

	link.click(); // This will download the data file named "ligamed_data.csv".

}

function runData(){
	var x = document.getElementById("line1");
    var y = document.getElementById("line2");
    if (x.style.display === "none") {
    	x.style.display = "block";
    	y.style.display = "block";
    }
    else {
    x.style.display = "none";
    y.style.display = "none";
    }

}


//loads csv file that has been saved from either page earlier
function loadFileAsText()
{
    var fileToLoad = document.getElementById("fileToLoad").files[0];
 
    var fileReader = new FileReader();
    fileReader.onload = function(fileLoadedEvent) 
    {
        var uploadArray = fileLoadedEvent.target.result;
        fullArray = csv2array(uploadArray,',');
        fullArray.reverse();
        fullArray.pop()
        fullArray.reverse();
    };
    fileReader.readAsText(fileToLoad, "UTF-8");
}

//http://www.speqmath.com/tutorials/csv2array/ 
//Shamelessly borrowed. Probably could have been edited down, but it's working and I don't want to break things
function csv2array(data, delimeter) {
  // Retrieve the delimeter
  if (delimeter == undefined) 
    delimeter = ',';
  if (delimeter && delimeter.length > 1)
    delimeter = ',';

  // initialize variables
  var newline = '\n';
  var eof = '';
  var i = 0;
  var c = data.charAt(i);
  var row = 0;
  var col = 0;
  var array = new Array();

  while (c != eof) {
    // skip whitespaces
    while (c == ' ' || c == '\t' || c == '\r') {
      c = data.charAt(++i); // read next char
    }
    
    // get value
    var value = "";
    if (c == '\"') {
      // value enclosed by double-quotes
      c = data.charAt(++i);
      
      do {
        if (c != '\"') {
          // read a regular character and go to the next character
          value += c;
          c = data.charAt(++i);
        }
        
        if (c == '\"') {
          // check for escaped double-quote
          var cnext = data.charAt(i+1);
          if (cnext == '\"') {
            // this is an escaped double-quote. 
            // Add a double-quote to the value, and move two characters ahead.
            value += '\"';
            i += 2;
            c = data.charAt(i);
          }
        }
      }
      while (c != eof && c != '\"');
      
      if (c == eof) {
        throw "Unexpected end of data, double-quote expected";
      }

      c = data.charAt(++i);
    }
    else {
      // value without quotes
      while (c != eof && c != delimeter && c!= newline && c != ' ' && c != '\t' && c != '\r') {
        value += c;
        c = data.charAt(++i);
      }
    }

    // add the value to the array
    if (array.length <= row) 
      array.push(new Array());
    array[row].push(value);
    
    // skip whitespaces
    while (c == ' ' || c == '\t' || c == '\r') {
      c = data.charAt(++i);
    }

    // go to the next row or column
    if (c == delimeter) {
      // to the next column
      col++;
    }
    else if (c == newline) {
      // to the next row
      col = 0;
      row++;
    }
    else if (c != eof) {
      // unexpected character

    }
    
    // go to the next character
    c = data.charAt(++i);
  }  
  
  return array;
}


</script>
</html>
